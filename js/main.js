// Generated by CoffeeScript 1.6.2
(function() {
  $(document).ready(function() {
    var betAmount, finishTable, firstRoll, handleResults, howToHandle, isWorkerPaused, isWorkerRunningIndefinitely, justKeepPlaying, lastNumWins, newTable, newTableIndefinitely, oddsPayout, pauseWorker, playCrapsAndHandleResults, rollsPerTable, runningTotal, secondRoll, showTotal, tellStory, totalWins, updateHeader, updateRunningTotal, whichChapter, wonAtFirstTable, wonFirstOrSecondRoll, worker;

    betAmount = 5;
    oddsPayout = 30;
    rollsPerTable = 20;
    runningTotal = 0;
    lastNumWins = 0;
    totalWins = 0;
    wonFirstOrSecondRoll = false;
    wonAtFirstTable = false;
    howToHandle = "";
    isWorkerRunningIndefinitely = false;
    isWorkerPaused = false;
    handleResults = function(numRolls, numWins, rollResults, howToHandle) {
      var $div, losses, tableTotal, total, winnings, wonOrLost;

      lastNumWins = numWins;
      totalWins += numWins;
      losses = (numRolls - numWins) * betAmount;
      winnings = numWins * betAmount * oddsPayout;
      total = winnings - losses;
      updateRunningTotal(total);
      if (howToHandle === "firstRoll" || howToHandle === "newTable") {
        $div = $("<div>").appendTo("article");
      } else {
        $div = $("article div").last();
      }
      if (rollResults !== "") {
        $div.append(rollResults);
        if (howToHandle === "finishTable" || howToHandle === "newTable") {
          tableTotal = howToHandle === "finishTable" ? runningTotal : total;
          wonOrLost = formatWinOrLoss(tableTotal, "Won " + (formatCurrency(tableTotal)), "Lost " + (formatCurrency(-tableTotal)), "Broke even");
          return $("<label>").text(wonOrLost.text).addClass(wonOrLost.result).appendTo($div);
        }
      }
    };
    updateHeader = function(text) {
      return $("header").text(text);
    };
    showTotal = function() {
      return $("footer").delay(1000).fadeIn(600);
    };
    worker = new Worker("js/playCrapsWorker.js");
    worker.addEventListener("message", function(e) {
      return handleResults(e.data.numRolls, e.data.numWins, e.data.rollResults, howToHandle);
    }, false);
    playCrapsAndHandleResults = function(numRolls) {
      var results;

      results = playCraps(numRolls, true);
      return handleResults(results.numRolls, results.numWins, results.rollResults, howToHandle);
    };
    firstRoll = function() {
      howToHandle = "firstRoll";
      return playCrapsAndHandleResults(1);
    };
    secondRoll = function() {
      howToHandle = "secondRoll";
      return playCrapsAndHandleResults(1);
    };
    finishTable = function() {
      howToHandle = "finishTable";
      return playCrapsAndHandleResults(rollsPerTable - 2);
    };
    newTable = function() {
      howToHandle = "newTable";
      return playCrapsAndHandleResults(rollsPerTable);
    };
    newTableIndefinitely = function(fastOrSlow) {
      howToHandle = "newTable";
      return worker.postMessage({
        command: "playCraps",
        numRolls: rollsPerTable,
        returnAllRolls: true,
        delay: fastOrSlow === "fast" ? 100 : 1000
      });
    };
    justKeepPlaying = function() {
      howToHandle = "justKeepPlaying";
      isWorkerPaused = false;
      isWorkerRunningIndefinitely = true;
      return worker.postMessage({
        command: "playCraps",
        numRolls: 1,
        returnAllRolls: false,
        delay: 10
      });
    };
    pauseWorker = function() {
      isWorkerPaused = true;
      isWorkerRunningIndefinitely = false;
      return worker.postMessage({
        command: "pause"
      });
    };
    $(document).on("keyup", function(e) {
      if (e.keyCode === 27) {
        if (isWorkerRunningIndefinitely) {
          return pauseWorker();
        } else if (isWorkerPaused) {
          return justKeepPlaying();
        }
      }
    });
    updateRunningTotal = function(newTotal) {
      var runningWinOrLoss;

      runningTotal += newTotal;
      runningWinOrLoss = formatWinOrLoss(runningTotal, "You've won a total of " + (formatCurrency(runningTotal)), "You've lost a total of " + (formatCurrency(-runningTotal)), "You're even");
      return $("footer").text(runningWinOrLoss.text).removeClass().addClass(runningWinOrLoss.result);
    };
    whichChapter = 1;
    tellStory = function() {
      switch (whichChapter) {
        case 1:
          updateHeader("So you're on your way from Charleston to Raleigh when you decide to make a quick stop in Atlantic City.");
          break;
        case 2:
          updateHeader("You sit down at a $5 craps table and the dealer tells you to place your bet.");
          break;
        case 3:
          updateHeader("You don't know anything about craps, so you bet on 12.");
          break;
        case 4:
          updateHeader("The shooter throws the dice, and...");
          break;
        case 5:
          firstRoll();
          if (lastNumWins === 1) {
            wonFirstOrSecondRoll = true;
            updateHeader("Lucky you. Boxcars on the first roll. You snatch up your winnings but leave your " + (formatCurrency(betAmount)) + " bet to play.");
          } else {
            updateHeader("Crap, you lost your first bet. It's ok, you knew this wouldn't be easy. You make another bet on 12.");
          }
          break;
        case 6:
          secondRoll();
          if (lastNumWins === 1) {
            wonFirstOrSecondRoll = true;
            if (totalWins === 2) {
              updateHeader("What are the odds? Two boxcars in a row, and suddenly you're a gambling addict. You keep playing.");
            } else {
              updateHeader("Hey, second time's the charm. Now you're hooked. Maybe you can hit boxcars again.");
            }
          } else {
            if (totalWins === 1) {
              updateHeader("What did you expect? Two wins in a row? But since you're up, you decide to keep playing for a while.");
            } else {
              updateHeader("Lost again. But now you're invested. You decide to play an even 20 rolls before walking away.");
            }
          }
          break;
        case 7:
          finishTable();
          switch (false) {
            case !(wonFirstOrSecondRoll && lastNumWins > 0):
              updateHeader("Seriously, you've found your calling. You cancel your pedicure appointment and play another 20 rolls.");
              break;
            case !(wonFirstOrSecondRoll && lastNumWins === 0):
              updateHeader("\"You can't win 'em all\", you tell yourself. But you're still up, so you decide to go for another 20 rolls.");
              break;
            case !(!wonFirstOrSecondRoll && lastNumWins > 1):
              updateHeader("Aren't you glad you stuck this out? Your parents would finally be so proud. You'd be an idiot not to go for another 20 rolls.");
              break;
            case !(!wonFirstOrSecondRoll && lastNumWins === 1):
              updateHeader("Hey, you did it. Boxcars. Since you're up, you might as well try another 20 rolls.");
              break;
            case !(!wonFirstOrSecondRoll && lastNumWins === 0):
              updateHeader("Nothin'. It must be the table. You slide over to another one and stand next to a man with a white hat and a cane.");
          }
          wonAtFirstTable = totalWins > 0;
          showTotal();
          break;
        case 8:
          newTable();
          switch (false) {
            case !(wonAtFirstTable && lastNumWins > 0):
              updateHeader("This is like printing money. \"Drinks all around!\", you say. The dealer reminds you that drinks are free, but you don't even hear him. You just keep playing.");
              break;
            case !(wonAtFirstTable && lastNumWins === 0):
              updateHeader("Maybe this table just isn't hot anymore. You've tasted what it's like to win, and it's too late to turn back now. You try another table.");
              break;
            case !(!wonAtFirstTable && lastNumWins > 0):
              updateHeader("Yes. It was definitely just that last table. The thrill of vicory compells you on.");
              break;
            case !(!wonAtFirstTable && lastNumWins === 0):
              updateHeader("Ok, seriously. Two crap tables in a row. What are you going to tell your friends? You've got to win at least once.");
          }
          break;
        case 9:
          newTableIndefinitely("slow");
          updateHeader("This is going to be a good investment.");
          break;
        case 10:
          newTableIndefinitely("fast");
          updateHeader("Maybe you're more hooked than you thought.");
          break;
        case 11:
          justKeepPlaying();
          updateHeader("You're right, let's skip the pleasantries and just see how this plays out.");
      }
      return whichChapter++;
    };
    $(document).on("keyup", function(e) {
      var _ref;

      if ((_ref = e.keyCode) === 13 || _ref === 39 || _ref === 32) {
        return tellStory();
      }
    });
    $(document).on("click", "header", tellStory);
    return tellStory();
  });

}).call(this);
